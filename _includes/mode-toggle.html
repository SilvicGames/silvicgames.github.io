<!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      // Inicia la aplicación de estilos tan pronto como sea posible
      this.applyMode();

      let self = this;

      // Siempre sigue las preferencias del sistema
      this.sysDarkPrefers.addEventListener('change', () => {
        if (!self.hasMode) {
          // Si no hay modo explícito, sigue la preferencia del sistema
          self.applyMode();
        }
        self.notify();
      });

      // Asegura que los estilos se apliquen después de que el DOM esté completamente cargado
      document.addEventListener('DOMContentLoaded', () => {
        self.applyMode();
      });
    }

    // Aplicar el modo actual (ya sea guardado o basado en preferencias del sistema)
    applyMode() {
      const currentMode = this.modeStatus;
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, currentMode);

      // Aplicar colores específicos a los controles del carrusel
      if (currentMode === ModeToggle.DARK_MODE) {
        this.setCarouselColorControls("#fafafa");
      } else {
        this.setCarouselColorControls("#000000");
      }
    }

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get isLightMode() {
      return this.mode === ModeToggle.LIGHT_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      // Usar localStorage en lugar de sessionStorage para persistencia entre sesiones
      return localStorage.getItem(ModeToggle.MODE_KEY);
    }

    // Modifica el getter modeStatus para ignorar la preferencia del sistema cuando hay un modo explícito
    get modeStatus() {
      // Si hay un modo definido explícitamente, respetarlo siempre
      if (this.hasMode) {
        return this.mode; // Usa el modo guardado (dark o light)
      }
      // Si no hay modo guardado, usar preferencia del sistema
      else if (this.isSysDarkPrefer) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setCarouselColorControls(color) {
      var carouselControls = document.querySelectorAll('.carousel__control');
      var carouselIndicators = document.querySelectorAll('.carousel__indicator');

      if (!carouselControls.length && !carouselIndicators.length) {
        // Si los elementos no existen todavía, programar para aplicar más tarde
        setTimeout(() => this.setCarouselColorControls(color), 100);
        return;
      }

      carouselControls.forEach(function (control) {
        control.style.setProperty('border-color', color, 'important');
      });
      carouselIndicators.forEach(function (control) {
        control.style.setProperty('background-color', "#fafafa", 'important');
      });
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      localStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      this.setCarouselColorControls("#fafafa");
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      localStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      this.setCarouselColorControls("#000000"); // Esto afectará solo a los controles, no a los indicadores
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      localStorage.removeItem(ModeToggle.MODE_KEY);

      // Al borrar, aplica según preferencia del sistema, pero los indicadores siempre blancos
      if (this.isSysDarkPrefer) {
        this.setCarouselColorControls("#fafafa");
      } else {
        this.setCarouselColorControls("#000000");
      }
    }

    // Notificar a otros plugins que el modo de tema ha cambiado
    notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      // Simplificar la lógica para hacerla más directa y consistente
      if (this.isDarkMode) {
        // Si actualmente está en modo oscuro, cambiar a claro
        this.setLight();
      } else {
        // Si está en modo claro o no tiene modo definido, cambiar a oscuro
        this.setDark();
      }

      // Forzar la aplicación del modo
      this.applyMode();
      this.notify();
    }
  } /* ModeToggle */

  // Inicialización inmediata para evitar parpadeos
  const modeToggle = new ModeToggle();
</script>
